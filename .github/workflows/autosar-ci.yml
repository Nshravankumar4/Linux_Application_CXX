name: AUTOSAR C++ CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  BUILD_TYPE: Debug

jobs:
  autosar-ci:
    runs-on: ubuntu-latest

    steps:
    # --------------------------------------------------
    # 1Ô∏è‚É£ Checkout Source Code
    # --------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # --------------------------------------------------
    # 2Ô∏è‚É£ Install Build & Analysis Tools
    # --------------------------------------------------
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          cmake \
          g++ \
          ninja-build \
          cppcheck \
          lcov \
          libgtest-dev

    # --------------------------------------------------
    # 3Ô∏è‚É£ Build GoogleTest (Ubuntu Requirement)
    # --------------------------------------------------
    - name: Build GoogleTest
      run: |
        cd /usr/src/gtest
        sudo cmake .
        sudo make
        sudo cp *.a /usr/lib

    # --------------------------------------------------
    # 4Ô∏è‚É£ Configure CMake (AUTOSAR Style)
    # --------------------------------------------------
    - name: Configure (CMake)
      run: |
        cmake -S . -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
          -DENABLE_TESTS=ON

    # --------------------------------------------------
    # 5Ô∏è‚É£ Build Application
    # --------------------------------------------------
    - name: Build
      run: |
        cmake --build build

    # --------------------------------------------------
    # 6Ô∏è‚É£ Run Unit Tests (SWC Level)
    # --------------------------------------------------
    - name: Run Unit Tests
      run: |
        ctest --test-dir build --output-on-failure

    # --------------------------------------------------
    # 7Ô∏è‚É£ Static Analysis (AUTOSAR / MISRA Mindset)
    # --------------------------------------------------
    - name: Static Analysis (cppcheck)
      run: |
        cppcheck \
          --enable=all \
          --inline-suppr \
          --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          src/

    # --------------------------------------------------
    # 8Ô∏è‚É£ Configure Coverage Build (AUTOSAR Learning)
    # --------------------------------------------------
    - name: Configure Coverage Build
      run: |
        cmake -S . -B build-cov \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DENABLE_TESTS=ON \
          -DCMAKE_CXX_FLAGS="--coverage" \
          -DCMAKE_C_FLAGS="--coverage"

    # --------------------------------------------------
    # 9Ô∏è‚É£ Build Coverage Binary
    # --------------------------------------------------
    - name: Build Coverage
      run: |
        cmake --build build-cov

    # --------------------------------------------------
    # üîü Run Tests for Coverage
    # --------------------------------------------------
    - name: Run Tests (Coverage)
      run: |
        ctest --test-dir build-cov --output-on-failure

    # --------------------------------------------------
    # 1Ô∏è‚É£1Ô∏è‚É£ Generate Coverage Report
    # --------------------------------------------------
    - name: Generate Coverage Report
      run: |
        lcov --capture \
             --directory build-cov \
             --output-file coverage.info
        lcov --remove coverage.info \
             '/usr/*' \
             '*/tests/*' \
             --output-file coverage.info
        lcov --summary coverage.info

    # --------------------------------------------------
    # 1Ô∏è‚É£2Ô∏è‚É£ Coverage Quality Gate (AUTOSAR Style)
    # --------------------------------------------------
    - name: Coverage Quality Gate
      run: |
        lcov --summary coverage.info | grep -E "lines\.+:\s+100.0%"
